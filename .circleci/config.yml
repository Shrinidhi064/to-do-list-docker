version: 2.1

jobs:
  python-build:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install render-cli

  docker-build-push:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker  # Required to build Docker images
      - run:
          name: Install Docker CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y docker.io
      - run:
          name: Docker Login
          command: |
            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
      - run:
          name: Build and Push Docker Image
          command: |
            IMAGE_NAME=shrinidhi6/todo-flask-app:latest
            docker build -t $IMAGE_NAME .
            docker push $IMAGE_NAME

  deploy:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install render-cli
      - run:
          name: Check environment variables
          command: env | grep -i render || true
      - run:
          name: Show Render CLI version and list services
          command: |
            echo "Using Render CLI version:"
            render-cli --version
            echo "Listing services..."
            render-cli list || true
      - run:
          name: Trigger deploy via Deploy Hook
          command: |
            if [ -z "$RENDER_DEPLOY_HOOK" ]; then
              echo "Missing RENDER_DEPLOY_HOOK env variable." && exit 1
            fi
            echo "Triggering deploy via webhook..."
            curl -X POST $RENDER_DEPLOY_HOOK

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - python-build
      - docker-build-push:
          requires:
            - python-build
      - deploy:
          context: render-deploy-context
          requires:
            - docker-build-push
